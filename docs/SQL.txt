# AIUB Sports Portal - Complete Database Schema

## Overview
The AIUB Sports Portal uses Oracle 10g database with PL/SQL stored procedures, functions, and triggers. Below is the complete database schema with all tables, relationships, constraints, and sequences.

## Tables Structure

### 1. USERS Table
```sql
CREATE TABLE users (
    id NUMBER PRIMARY KEY,
    student_id VARCHAR2(50) NOT NULL UNIQUE,
    email VARCHAR2(100) NOT NULL UNIQUE,
    full_name VARCHAR2(200),
    gender VARCHAR2(20),
    name_edit_count NUMBER DEFAULT 0,
    is_first_login NUMBER(1) DEFAULT 1,
    phone_number VARCHAR2(20),
    program_level VARCHAR2(20),
    department VARCHAR2(100),
    blood_group VARCHAR2(5),
    profile_completed NUMBER(1) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    CONSTRAINT chk_gender CHECK (gender IN ('Male', 'Female', 'Other', NULL)),
    CONSTRAINT chk_edit_count CHECK (name_edit_count >= 0 AND name_edit_count <= 3),
    CONSTRAINT chk_first_login CHECK (is_first_login IN (0, 1)),
    CONSTRAINT chk_program_level CHECK (program_level IN ('Undergraduate', 'Postgraduate', NULL)),
    CONSTRAINT chk_blood_group CHECK (blood_group IN ('A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-', NULL))
);
```

**Indexes:**
- `idx_student_id` ON users(student_id)
- `idx_email` ON users(email)

**Triggers:**
- `users_bir` - BEFORE INSERT to set ID using sequence
- `users_bur` - BEFORE UPDATE to update 'updated_at' timestamp

**Functions:**
- `validate_aiub_email(p_email)` - Validates AIUB email format

**Procedures:**
- `register_user(p_student_id, p_email, p_user_id OUT, p_status OUT)` - Register new user
- `update_user_profile(p_student_id, p_full_name, p_gender, p_is_first_time, p_status OUT)` - Update user profile
- `get_user_profile(p_student_id)` - Get user profile

**Sequence:**
- `user_id_seq` - For generating user IDs

---

### 2. ADMINS Table
```sql
CREATE TABLE admins (
    id NUMBER PRIMARY KEY,
    admin_id VARCHAR2(50) NOT NULL UNIQUE,
    email VARCHAR2(100) NOT NULL UNIQUE,
    full_name VARCHAR2(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Sequence:**
- `admin_id_seq` - For generating admin IDs

**Trigger:**
- `admins_bir` - BEFORE INSERT to set ID using sequence

---

### 3. TOURNAMENTS Table
```sql
CREATE TABLE tournaments (
    id NUMBER PRIMARY KEY,
    title VARCHAR2(300) NOT NULL,
    photo_url CLOB,
    registration_deadline TIMESTAMP NOT NULL,
    status VARCHAR2(20) DEFAULT 'ACTIVE',
    created_by NUMBER REFERENCES admins(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    description VARCHAR2(1000),  -- Added later
    CONSTRAINT chk_tournament_status CHECK (status IN ('ACTIVE', 'CLOSED', 'COMPLETED'))
);
```

**Sequence:**
- `tournament_id_seq` - For generating tournament IDs

**Trigger:**
- `tournaments_bir` - BEFORE INSERT to set ID using sequence

---

### 4. TOURNAMENT_GAMES Table
```sql
CREATE TABLE tournament_games (
    id NUMBER PRIMARY KEY,
    tournament_id NUMBER NOT NULL REFERENCES tournaments(id) ON DELETE CASCADE,
    category VARCHAR2(20) NOT NULL,
    game_name VARCHAR2(200) NOT NULL,
    game_type VARCHAR2(50) NOT NULL,
    fee_per_person NUMBER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_game_category CHECK (category IN ('Male', 'Female', 'Mix')),
    CONSTRAINT chk_game_type CHECK (game_type IN ('Solo', 'Duo', 'Custom'))
);
```

**Sequence:**
- `game_id_seq` - For generating game IDs

**Trigger:**
- `games_bir` - BEFORE INSERT to set ID using sequence

---

### 5. GAME_REGISTRATIONS Table
```sql
CREATE TABLE game_registrations (
    id NUMBER PRIMARY KEY,
    game_id NUMBER NOT NULL REFERENCES tournament_games(id) ON DELETE CASCADE,
    user_id NUMBER NOT NULL REFERENCES users(id),
    registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    payment_status VARCHAR2(20) DEFAULT 'PENDING',
    CONSTRAINT chk_payment_status CHECK (payment_status IN ('PENDING', 'PAID', 'FAILED'))
);
```

**Sequence:**
- `registration_id_seq` - For generating registration IDs

**Trigger:**
- `registrations_bir` - BEFORE INSERT to set ID using sequence

---

## Table Relationships

### Primary Relationships
1. **admins** → **tournaments** (created_by field)
2. **tournaments** → **tournament_games** (tournament_id foreign key)
3. **tournament_games** → **game_registrations** (game_id foreign key)
4. **users** → **game_registrations** (user_id foreign key)

### Entity Relationship Diagram
```
admins (1) → tournaments (M)
tournaments (1) → tournament_games (M)
tournament_games (1) → game_registrations (M)
users (1) → game_registrations (M)
```

## Data Flow
1. **Admin** creates **Tournament**
2. **Tournament** contains multiple **Tournament_Games**
3. **Users** register for **Tournament_Games** creating **Game_Registrations**

## Data Normalization

### First Normal Form (1NF)
✅ **Achieved** - All tables have atomic values and unique column names
- No repeating groups in any table
- Each column contains only one value per row

### Second Normal Form (2NF)
✅ **Achieved** - All tables are in 1NF and all non-key attributes are fully functionally dependent on the primary key
- No partial dependencies on composite keys (no composite keys exist in this schema)

### Third Normal Form (3NF)
✅ **Achieved** - All tables are in 2NF and no transitive dependencies exist
- All non-key attributes depend only on the primary key
- No derived or calculated fields stored in tables

### Normalization Benefits
- **Reduced data redundancy** - Each piece of information is stored in only one place
- **Improved data integrity** - Updates to information only need to happen in one location
- **Simplified queries** - Clear relationships between entities
- **Efficient storage** - No duplicate data wasting space

## Database Relationships & Referential Integrity

### Primary Relationships
1. **admins** → **tournaments** (created_by field)
   - One-to-Many: One admin can create many tournaments
   
2. **tournaments** → **tournament_games** (tournament_id foreign key)
   - One-to-Many: One tournament can have many games
   
3. **tournament_games** → **game_registrations** (game_id foreign key)
   - One-to-Many: One game can have many registrations
   
4. **users** → **game_registrations** (user_id foreign key)
   - One-to-Many: One user can register for many games

### Referential Integrity Measures
- **CASCADE DELETE**: When a tournament is deleted, its games and registrations are automatically deleted
- **Foreign Key Constraints**: Ensure data consistency between related tables
- **Check Constraints**: Validate business rules at database level

## Constraint Summary
- **Users table:** Gender, Edit count, Program level, Blood group, First login
- **Tournaments table:** Status (ACTIVE/CLOSED/COMPLETED)
- **Tournament_Games table:** Category (Male/Female/Mix), Game type (Solo/Duo/Custom)
- **Game_Registrations table:** Payment status (PENDING/PAID/FAILED)

## Sequence Summary
- `user_id_seq` - For users table IDs
- `admin_id_seq` - For admins table IDs
- `tournament_id_seq` - For tournaments table IDs
- `game_id_seq` - For tournament_games table IDs
- `registration_id_seq` - For game_registrations table IDs

## Indexes
- `users` table: indexed on `student_id` and `email` for faster lookups
- All primary keys are automatically indexed by Oracle

## Additional Oracle Objects

### Stored Procedures
- `register_user` - Handles new user registration with validation
- `update_user_profile` - Manages profile updates with validation and business rules
- `get_user_profile` - Retrieves user profile data with security

### Stored Functions
- `validate_aiub_email` - Validates AIUB student email format (XX-XXXXX-X@student.aiub.edu)

### Triggers
- **users_bir** - BEFORE INSERT trigger to assign ID using sequence
- **users_bur** - BEFORE UPDATE trigger to update 'updated_at' timestamp
- **admins_bir** - BEFORE INSERT trigger to assign admin ID
- **tournaments_bir** - BEFORE INSERT trigger to assign tournament ID
- **games_bir** - BEFORE INSERT trigger to assign game ID
- **registrations_bir** - BEFORE INSERT trigger to assign registration ID

## Database Optimization Features

### Performance Optimization
- **Indexes** on frequently queried columns (student_id, email)
- **Sequences** for efficient ID generation without locking
- **Constraints** enforced at database level for performance

### Security Features
- **Email validation** at database level using stored functions
- **Constrained data types** to prevent invalid data
- **Referential integrity** to maintain data consistency

### Data Integrity
- **Check constraints** to enforce business rules
- **Foreign key constraints** to maintain relationships
- **Default values** to ensure consistent data entry

## Email Validation Pattern
- Pattern: `^\d{2}-\d{5}-\d@student\.aiub\.edu$`
- Example: `24-56434-1@student.aiub.edu`
- Format: `XX-XXXXX-X@student.aiub.edu`

## Name Edit Limit
- Users can edit their name up to 3 times
- After 3 edits, name field becomes locked
- Track with `name_edit_count` field in users table

## Profile Completion Rules
- Gender, Program level, and Department: Locked after first setup
- Phone number and Blood group: Editable anytime
- Name: Editable up to 3 times
- First-time profile completion required before accessing dashboard

## Finalization & Implementation Notes

### Schema Implementation Status
✅ **Fully Implemented** - All tables, relationships, and constraints are active
✅ **Production Ready** - Schema is optimized for performance and security
✅ **Business Rules Enforced** - All validation constraints are in place at database level

### Performance Considerations
- **Index Optimization**: Critical fields (student_id, email) are indexed for fast lookups
- **Sequence Usage**: Efficient ID generation without table locking
- **Constraint Validation**: Business rules enforced at database level rather than application level

### Security Features
- **Email Format Validation**: AIUB-specific format enforced at database level
- **Referential Integrity**: Foreign key constraints prevent orphaned records
- **Default Values**: Consistent data entry enforced through defaults
- **Check Constraints**: Business rules validated automatically

### Scalability Features
- **Normalized Design**: Reduces data redundancy and maintains consistency
- **Proper Indexing**: Supports growth in user base and tournament offerings
- **Sequence Management**: Handles concurrent user access without conflicts
- **Clean Relationships**: Supports additional feature development

### Maintenance Considerations
- **Clear Relationships**: Well-defined foreign key constraints
- **Documented Constraints**: All business rules are clear and enforced
- **Standard Oracle Objects**: Uses Oracle best practices for PL/SQL
- **Audit Trail**: Timestamps and status fields for tracking data changes

### Migration Notes
- Existing data will conform to new schema requirements
- No data loss during schema implementation
- All existing functionality preserved and enhanced

This schema supports the complete AIUB Sports Portal functionality with proper security, validation, and data relationships.