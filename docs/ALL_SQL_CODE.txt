# AIUB Sports Portal - Complete SQL & PL/SQL Code Collection

## 1. SCHEMA CREATION SCRIPTS

### 1.1 main-schema.sql (Original Users Table)
```sql
-- AIUB Sports Portal Database Schema
-- Oracle 10g PL/SQL
-- Version 1.0

-- Drop existing tables if they exist (for clean setup)
BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE users CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN
         RAISE;
      END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP SEQUENCE user_id_seq';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -2289 THEN
         RAISE;
      END IF;
END;
/

-- Create sequence for user IDs
CREATE SEQUENCE user_id_seq
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;
/

-- Create Users Table
CREATE TABLE users (
    id NUMBER PRIMARY KEY,
    student_id VARCHAR2(50) NOT NULL UNIQUE,
    email VARCHAR2(100) NOT NULL UNIQUE,
    full_name VARCHAR2(200),
    gender VARCHAR2(20),
    name_edit_count NUMBER DEFAULT 0,
    is_first_login NUMBER(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    CONSTRAINT chk_gender CHECK (gender IN ('Male', 'Female', 'Other', NULL)),
    CONSTRAINT chk_edit_count CHECK (name_edit_count >= 0 AND name_edit_count <= 3),
    CONSTRAINT chk_first_login CHECK (is_first_login IN (0, 1))
);
/

-- Create index for faster lookups
CREATE INDEX idx_student_id ON users(student_id);
CREATE INDEX idx_email ON users(email);
/

-- Trigger to automatically set ID using sequence
CREATE OR REPLACE TRIGGER users_bir
BEFORE INSERT ON users
FOR EACH ROW
BEGIN
    IF :new.id IS NULL THEN
        SELECT user_id_seq.NEXTVAL INTO :new.id FROM dual;
    END IF;
END;
/

-- Trigger to update 'updated_at' timestamp
CREATE OR REPLACE TRIGGER users_bur
BEFORE UPDATE ON users
FOR EACH ROW
BEGIN
    :new.updated_at := CURRENT_TIMESTAMP;
END;
/

-- Function to validate AIUB email format
CREATE OR REPLACE FUNCTION validate_aiub_email(p_email IN VARCHAR2)
RETURN NUMBER
IS
    v_pattern VARCHAR2(100) := '^\d{2}-\d{5}-\d@student\.aiub\.edu$';
BEGIN
    IF REGEXP_LIKE(p_email, v_pattern) THEN
        RETURN 1; -- Valid
    ELSE
        RETURN 0; -- Invalid
    END IF;
END;
/

-- Procedure to register new user
CREATE OR REPLACE PROCEDURE register_user(
    p_student_id IN VARCHAR2,
    p_email IN VARCHAR2,
    p_user_id OUT NUMBER,
    p_status OUT VARCHAR2
)
IS
    v_count NUMBER;
    v_valid NUMBER;
BEGIN
    -- Validate email format
    v_valid := validate_aiub_email(p_email);

    IF v_valid = 0 THEN
        p_status := 'INVALID_EMAIL';
        RETURN;
    END IF;

    -- Check if user already exists
    SELECT COUNT(*) INTO v_count
    FROM users
    WHERE student_id = p_student_id OR email = p_email;

    IF v_count > 0 THEN
        p_status := 'USER_EXISTS';
        SELECT id INTO p_user_id FROM users WHERE student_id = p_student_id;
    ELSE
        -- Insert new user
        INSERT INTO users (student_id, email, is_first_login, last_login)
        VALUES (p_student_id, p_email, 1, CURRENT_TIMESTAMP)
        RETURNING id INTO p_user_id;

        COMMIT;
        p_status := 'SUCCESS';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        p_status := 'ERROR: ' || SQLERRM;
        ROLLBACK;
END;
/

-- Procedure to update user profile
CREATE OR REPLACE PROCEDURE update_user_profile(
    p_student_id IN VARCHAR2,
    p_full_name IN VARCHAR2,
    p_gender IN VARCHAR2,
    p_is_first_time IN NUMBER,
    p_status OUT VARCHAR2
)
IS
    v_current_count NUMBER;
    v_current_name VARCHAR2(200);
    v_is_first NUMBER;
BEGIN
    -- Get current user data
    SELECT name_edit_count, full_name, is_first_login
    INTO v_current_count, v_current_name, v_is_first
    FROM users
    WHERE student_id = p_student_id;

    -- First time profile completion
    IF p_is_first_time = 1 THEN
        UPDATE users
        SET full_name = p_full_name,
            gender = p_gender,
            is_first_login = 0,
            name_edit_count = 0,
            last_login = CURRENT_TIMESTAMP
        WHERE student_id = p_student_id;

        COMMIT;
        p_status := 'PROFILE_CREATED';
        RETURN;
    END IF;

    -- Subsequent updates
    -- Check if name is being changed
    IF v_current_name != p_full_name THEN
        IF v_current_count >= 3 THEN
            p_status := 'NAME_EDIT_LIMIT_REACHED';
            RETURN;
        END IF;

        UPDATE users
        SET full_name = p_full_name,
            name_edit_count = v_current_count + 1,
            last_login = CURRENT_TIMESTAMP
        WHERE student_id = p_student_id;

        COMMIT;
        p_status := 'NAME_UPDATED';
    ELSE
        -- Just update last login
        UPDATE users
        SET last_login = CURRENT_TIMESTAMP
        WHERE student_id = p_student_id;

        COMMIT;
        p_status := 'LOGIN_UPDATED';
    END IF;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        p_status := 'USER_NOT_FOUND';
    WHEN OTHERS THEN
        p_status := 'ERROR: ' || SQLERRM;
        ROLLBACK;
END;
/

-- Function to get user profile
CREATE OR REPLACE FUNCTION get_user_profile(p_student_id IN VARCHAR2)
RETURN SYS_REFCURSOR
IS
    v_cursor SYS_REFCURSOR;
BEGIN
    OPEN v_cursor FOR
        SELECT
            id,
            student_id,
            email,
            full_name,
            gender,
            name_edit_count,
            is_first_login,
            created_at,
            updated_at,
            last_login
        FROM users
        WHERE student_id = p_student_id;

    RETURN v_cursor;
END;
/

-- Insert some test data (optional)
BEGIN
    DECLARE
        v_user_id NUMBER;
        v_status VARCHAR2(100);
    BEGIN
        -- Test user 1
        register_user('24-56434-1', '24-56434-1@student.aiub.edu', v_user_id, v_status);
        DBMS_OUTPUT.PUT_LINE('Test User 1: ' || v_status);
    END;
END;
/

-- Verify installation
SELECT 'Schema created successfully!' AS status FROM dual;
SELECT COUNT(*) AS total_users FROM users;

COMMIT;
```

### 1.2 enhanced_schema.sql (Enhanced Users Table)
```sql
-- Enhanced Schema - Add new fields to users table
-- Version 1.2

-- Add new columns to existing users table
ALTER TABLE users ADD (
    phone_number VARCHAR2(20),
    program_level VARCHAR2(20),
    department VARCHAR2(100),
    blood_group VARCHAR2(5),
    profile_completed NUMBER(1) DEFAULT 0,
    CONSTRAINT chk_program_level CHECK (program_level IN ('Undergraduate', 'Postgraduate', NULL)),
    CONSTRAINT chk_blood_group CHECK (blood_group IN ('A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-', NULL))
);

-- Add comment for documentation
COMMENT ON COLUMN users.phone_number IS 'User phone number - editable anytime';
COMMENT ON COLUMN users.program_level IS 'Undergraduate or Postgraduate - locked after first submission';
COMMENT ON COLUMN users.department IS 'Department name - locked after first submission';
COMMENT ON COLUMN users.blood_group IS 'Blood group - editable anytime';
COMMENT ON COLUMN users.profile_completed IS '1 if profile fully completed, 0 otherwise';

-- Update existing test user
UPDATE users
SET profile_completed = 0
WHERE profile_completed IS NULL;

COMMIT;

SELECT 'Enhanced schema created successfully!' AS status FROM dual;
```

### 1.3 admin-schema.sql (Admin & Tournament Tables)
```sql
-- Admin & Tournament Schema
-- Version 1.3

-- Admins Table
CREATE TABLE admins (
    id NUMBER PRIMARY KEY,
    admin_id VARCHAR2(50) NOT NULL UNIQUE,
    email VARCHAR2(100) NOT NULL UNIQUE,
    full_name VARCHAR2(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE SEQUENCE admin_id_seq START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER admins_bir
BEFORE INSERT ON admins FOR EACH ROW
BEGIN
    IF :new.id IS NULL THEN
        SELECT admin_id_seq.NEXTVAL INTO :new.id FROM dual;
    END IF;
END;
/

-- Tournaments Table
CREATE TABLE tournaments (
    id NUMBER PRIMARY KEY,
    title VARCHAR2(300) NOT NULL,
    photo_url CLOB,
    registration_deadline TIMESTAMP NOT NULL,
    status VARCHAR2(20) DEFAULT 'ACTIVE',
    created_by NUMBER REFERENCES admins(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    description VARCHAR2(1000),  -- Added later
    CONSTRAINT chk_tournament_status CHECK (status IN ('ACTIVE', 'CLOSED', 'COMPLETED'))
);

CREATE SEQUENCE tournament_id_seq START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER tournaments_bir
BEFORE INSERT ON tournaments FOR EACH ROW
BEGIN
    IF :new.id IS NULL THEN
        SELECT tournament_id_seq.NEXTVAL INTO :new.id FROM dual;
    END IF;
END;
/

-- Tournament Games Table
CREATE TABLE tournament_games (
    id NUMBER PRIMARY KEY,
    tournament_id NUMBER NOT NULL REFERENCES tournaments(id) ON DELETE CASCADE,
    category VARCHAR2(20) NOT NULL,
    game_name VARCHAR2(200) NOT NULL,
    game_type VARCHAR2(50) NOT NULL,
    fee_per_person NUMBER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_game_category CHECK (category IN ('Male', 'Female', 'Mix')),
    CONSTRAINT chk_game_type CHECK (game_type IN ('Solo', 'Duo', 'Custom'))
);

CREATE SEQUENCE game_id_seq START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER games_bir
BEFORE INSERT ON tournament_games FOR EACH ROW
BEGIN
    IF :new.id IS NULL THEN
        SELECT game_id_seq.NEXTVAL INTO :new.id FROM dual;
    END IF;
END;
/

-- Game Registrations Table
CREATE TABLE game_registrations (
    id NUMBER PRIMARY KEY,
    game_id NUMBER NOT NULL REFERENCES tournament_games(id) ON DELETE CASCADE,
    user_id NUMBER NOT NULL REFERENCES users(id),
    registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    payment_status VARCHAR2(20) DEFAULT 'PENDING',
    CONSTRAINT chk_payment_status CHECK (payment_status IN ('PENDING', 'PAID', 'FAILED'))
);

CREATE SEQUENCE registration_id_seq START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER registrations_bir
BEFORE INSERT ON game_registrations FOR EACH ROW
BEGIN
    IF :new.id IS NULL THEN
        SELECT registration_id_seq.NEXTVAL INTO :new.id FROM dual;
    END IF;
END;
/

-- Insert test admin
INSERT INTO admins (admin_id, email, full_name)
VALUES ('admin001', 'admin@aiub.edu', 'System Admin');

COMMIT;

SELECT 'Admin schema created successfully!' FROM dual;
```

## 2. DATABASE ALTERATIONS

### 2.1 Description Column Addition
```sql
ALTER TABLE tournaments ADD description VARCHAR2(1000);
```

## 3. STORED PROCEDURES & FUNCTIONS

### 3.1 User Validation Function
```sql
CREATE OR REPLACE FUNCTION validate_aiub_email(p_email IN VARCHAR2)
RETURN NUMBER
IS
    v_pattern VARCHAR2(100) := '^\d{2}-\d{5}-\d@student\.aiub\.edu$';
BEGIN
    IF REGEXP_LIKE(p_email, v_pattern) THEN
        RETURN 1; -- Valid
    ELSE
        RETURN 0; -- Invalid
    END IF;
END;
/
```

### 3.2 User Registration Procedure
```sql
CREATE OR REPLACE PROCEDURE register_user(
    p_student_id IN VARCHAR2,
    p_email IN VARCHAR2,
    p_user_id OUT NUMBER,
    p_status OUT VARCHAR2
)
IS
    v_count NUMBER;
    v_valid NUMBER;
BEGIN
    -- Validate email format
    v_valid := validate_aiub_email(p_email);

    IF v_valid = 0 THEN
        p_status := 'INVALID_EMAIL';
        RETURN;
    END IF;

    -- Check if user already exists
    SELECT COUNT(*) INTO v_count
    FROM users
    WHERE student_id = p_student_id OR email = p_email;

    IF v_count > 0 THEN
        p_status := 'USER_EXISTS';
        SELECT id INTO p_user_id FROM users WHERE student_id = p_student_id;
    ELSE
        -- Insert new user
        INSERT INTO users (student_id, email, is_first_login, last_login)
        VALUES (p_student_id, p_email, 1, CURRENT_TIMESTAMP)
        RETURNING id INTO p_user_id;

        COMMIT;
        p_status := 'SUCCESS';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        p_status := 'ERROR: ' || SQLERRM;
        ROLLBACK;
END;
/
```

### 3.3 Profile Update Procedure
```sql
CREATE OR REPLACE PROCEDURE update_user_profile(
    p_student_id IN VARCHAR2,
    p_full_name IN VARCHAR2,
    p_gender IN VARCHAR2,
    p_is_first_time IN NUMBER,
    p_status OUT VARCHAR2
)
IS
    v_current_count NUMBER;
    v_current_name VARCHAR2(200);
    v_is_first NUMBER;
BEGIN
    -- Get current user data
    SELECT name_edit_count, full_name, is_first_login
    INTO v_current_count, v_current_name, v_is_first
    FROM users
    WHERE student_id = p_student_id;

    -- First time profile completion
    IF p_is_first_time = 1 THEN
        UPDATE users
        SET full_name = p_full_name,
            gender = p_gender,
            is_first_login = 0,
            name_edit_count = 0,
            last_login = CURRENT_TIMESTAMP
        WHERE student_id = p_student_id;

        COMMIT;
        p_status := 'PROFILE_CREATED';
        RETURN;
    END IF;

    -- Subsequent updates
    -- Check if name is being changed
    IF v_current_name != p_full_name THEN
        IF v_current_count >= 3 THEN
            p_status := 'NAME_EDIT_LIMIT_REACHED';
            RETURN;
        END IF;

        UPDATE users
        SET full_name = p_full_name,
            name_edit_count = v_current_count + 1,
            last_login = CURRENT_TIMESTAMP
        WHERE student_id = p_student_id;

        COMMIT;
        p_status := 'NAME_UPDATED';
    ELSE
        -- Just update last login
        UPDATE users
        SET last_login = CURRENT_TIMESTAMP
        WHERE student_id = p_student_id;

        COMMIT;
        p_status := 'LOGIN_UPDATED';
    END IF;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        p_status := 'USER_NOT_FOUND';
    WHEN OTHERS THEN
        p_status := 'ERROR: ' || SQLERRM;
        ROLLBACK;
END;
/
```

### 3.4 Profile Retrieval Function
```sql
CREATE OR REPLACE FUNCTION get_user_profile(p_student_id IN VARCHAR2)
RETURN SYS_REFCURSOR
IS
    v_cursor SYS_REFCURSOR;
BEGIN
    OPEN v_cursor FOR
        SELECT
            id,
            student_id,
            email,
            full_name,
            gender,
            name_edit_count,
            is_first_login,
            created_at,
            updated_at,
            last_login
        FROM users
        WHERE student_id = p_student_id;

    RETURN v_cursor;
END;
/
```

## 4. TRIGGERS

### 4.1 Users Table Triggers
```sql
-- Trigger to automatically set ID using sequence
CREATE OR REPLACE TRIGGER users_bir
BEFORE INSERT ON users
FOR EACH ROW
BEGIN
    IF :new.id IS NULL THEN
        SELECT user_id_seq.NEXTVAL INTO :new.id FROM dual;
    END IF;
END;
/

-- Trigger to update 'updated_at' timestamp
CREATE OR REPLACE TRIGGER users_bur
BEFORE UPDATE ON users
FOR EACH ROW
BEGIN
    :new.updated_at := CURRENT_TIMESTAMP;
END;
/
```

### 4.2 Admins Table Trigger
```sql
CREATE OR REPLACE TRIGGER admins_bir
BEFORE INSERT ON admins FOR EACH ROW
BEGIN
    IF :new.id IS NULL THEN
        SELECT admin_id_seq.NEXTVAL INTO :new.id FROM dual;
    END IF;
END;
/
```

### 4.3 Tournaments Table Trigger
```sql
CREATE OR REPLACE TRIGGER tournaments_bir
BEFORE INSERT ON tournaments FOR EACH ROW
BEGIN
    IF :new.id IS NULL THEN
        SELECT tournament_id_seq.NEXTVAL INTO :new.id FROM dual;
    END IF;
END;
/
```

### 4.4 Tournament Games Table Trigger
```sql
CREATE OR REPLACE TRIGGER games_bir
BEFORE INSERT ON tournament_games FOR EACH ROW
BEGIN
    IF :new.id IS NULL THEN
        SELECT game_id_seq.NEXTVAL INTO :new.id FROM dual;
    END IF;
END;
/
```

### 4.5 Game Registrations Table Trigger
```sql
CREATE OR REPLACE TRIGGER registrations_bir
BEFORE INSERT ON game_registrations FOR EACH ROW
BEGIN
    IF :new.id IS NULL THEN
        SELECT registration_id_seq.NEXTVAL INTO :new.id FROM dual;
    END IF;
END;
/
```

## 5. SEQUENCES

### 5.1 All Sequences Used
```sql
-- User ID sequence
CREATE SEQUENCE user_id_seq
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- Admin ID sequence
CREATE SEQUENCE admin_id_seq START WITH 1 INCREMENT BY 1;

-- Tournament ID sequence
CREATE SEQUENCE tournament_id_seq START WITH 1 INCREMENT BY 1;

-- Game ID sequence
CREATE SEQUENCE game_id_seq START WITH 1 INCREMENT BY 1;

-- Registration ID sequence
CREATE SEQUENCE registration_id_seq START WITH 1 INCREMENT BY 1;
```

## 6. INDEXES

### 6.1 Created Indexes
```sql
-- Index for faster lookups
CREATE INDEX idx_student_id ON users(student_id);
CREATE INDEX idx_email ON users(email);
```

## 7. CHECK CONSTRAINTS & BUSINESS RULES

### 7.1 Users Table Constraints
```sql
-- Gender check constraint
ALTER TABLE users ADD CONSTRAINT chk_gender 
CHECK (gender IN ('Male', 'Female', 'Other', NULL));

-- Name edit count constraint
ALTER TABLE users ADD CONSTRAINT chk_edit_count 
CHECK (name_edit_count >= 0 AND name_edit_count <= 3);

-- First login flag constraint
ALTER TABLE users ADD CONSTRAINT chk_first_login 
CHECK (is_first_login IN (0, 1));

-- Program level constraint
ALTER TABLE users ADD CONSTRAINT chk_program_level 
CHECK (program_level IN ('Undergraduate', 'Postgraduate', NULL));

-- Blood group constraint
ALTER TABLE users ADD CONSTRAINT chk_blood_group 
CHECK (blood_group IN ('A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-', NULL));

-- Profile completed constraint
ALTER TABLE users ADD CONSTRAINT chk_profile_completed 
CHECK (profile_completed IN (0, 1, NULL));
```

### 7.2 Tournaments Table Constraints
```sql
-- Tournament status constraint
ALTER TABLE tournaments ADD CONSTRAINT chk_tournament_status 
CHECK (status IN ('ACTIVE', 'CLOSED', 'COMPLETED'));
```

### 7.3 Tournament Games Table Constraints
```sql
-- Game category constraint
ALTER TABLE tournament_games ADD CONSTRAINT chk_game_category 
CHECK (category IN ('Male', 'Female', 'Mix'));

-- Game type constraint
ALTER TABLE tournament_games ADD CONSTRAINT chk_game_type 
CHECK (game_type IN ('Solo', 'Duo', 'Custom'));
```

### 7.4 Game Registrations Table Constraints
```sql
-- Payment status constraint
ALTER TABLE game_registrations ADD CONSTRAINT chk_payment_status 
CHECK (payment_status IN ('PENDING', 'PAID', 'FAILED'));
```

## 8. DATA INSERTIONS

### 8.1 Test Data
```sql
-- Insert test admin
INSERT INTO admins (admin_id, email, full_name)
VALUES ('admin001', 'admin@aiub.edu', 'System Admin');

-- Insert test user (from original schema)
BEGIN
    DECLARE
        v_user_id NUMBER;
        v_status VARCHAR2(100);
    BEGIN
        -- Test user 1
        register_user('24-56434-1', '24-56434-1@student.aiub.edu', v_user_id, v_status);
        DBMS_OUTPUT.PUT_LINE('Test User 1: ' || v_status);
    END;
END;
/
```

## 9. UTILITY QUERIES

### 9.1 Verification Queries
```sql
-- Verify schema creation
SELECT 'Schema created successfully!' AS status FROM dual;
SELECT COUNT(*) AS total_users FROM users;
SELECT COUNT(*) AS total_admins FROM admins;
SELECT COUNT(*) AS total_tournaments FROM tournaments;
SELECT COUNT(*) AS total_games FROM tournament_games;
SELECT COUNT(*) AS total_registrations FROM game_registrations;
```

### 9.2 Common Administrative Queries
```sql
-- Get all active tournaments with registration deadlines
SELECT id, title, TO_CHAR(registration_deadline, 'YYYY-MM-DD HH24:MI:SS') as deadline, status
FROM tournaments
WHERE status = 'ACTIVE' 
  AND registration_deadline > CURRENT_TIMESTAMP
ORDER BY registration_deadline ASC;

-- Get all games for a specific tournament
SELECT id, category, game_name, game_type, fee_per_person
FROM tournament_games
WHERE tournament_id = :tournament_id
ORDER BY category, game_name;

-- Get user registrations
SELECT 
    gr.id as registration_id,
    tg.game_name,
    tg.category,
    tg.game_type,
    tg.fee_per_person,
    t.title as tournament_title,
    gr.payment_status,
    TO_CHAR(gr.registration_date, 'YYYY-MM-DD HH24:MI:SS') as registration_date
FROM game_registrations gr
JOIN tournament_games tg ON gr.game_id = tg.id
JOIN tournaments t ON tg.tournament_id = t.id
WHERE gr.user_id = :user_id
ORDER BY gr.registration_date DESC;

-- Check if user is admin
SELECT id, admin_id, email, full_name FROM admins WHERE email = :email;
```

This comprehensive file contains ALL SQL and PL/SQL code used in your AIUB Sports Portal project, including schema definitions, stored procedures, functions, triggers, sequences, constraints, and utility queries.